@page "/uploadvideo"
@using System.Text.Json
@using BehaviorTest.Application.RBAC.Entity
@inject IVideoService VideoService
@inject IJSRuntime JSRuntime
@inject IAudioService AudioService
@inject ISummaryService SummaryService
@inject IClassroomEvaluationService ClassroomEvaluationService
@inject IMicroLessonService MicroLessonService

<PageTitle>è§†é¢‘ä¸Šä¼ </PageTitle>

<h1>è§†é¢‘ä¸Šä¼ ä¸ç®¡ç†</h1>

<div class="container">
    @* ========================================== *@
    @* ğŸ†• æ–°å¢åŒºåŸŸï¼šè¯¾ç¨‹/å¾®è¯¾è®¾ç½® *@
    @* ========================================== *@
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h3 class="mb-0">ğŸ“š è¯¾ç¨‹è®¾ç½®</h3>
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-center">
                        @* 1. é€‰æ‹©å·²æœ‰è¯¾ç¨‹ *@
                        <div class="col-md-5">
                            <label class="form-label">é€‰æ‹©å½“å‰è¯¾ç¨‹ï¼ˆå°†ä¸å½•åˆ¶çš„è§†é¢‘å…³è”ï¼‰ï¼š</label>
                            <select class="form-select" @bind="currentMicroLessonId">
                                <option value="">-- ä¸å…³è”ç‰¹å®šè¯¾ç¨‹ --</option>
                                @foreach (var lesson in microLessons)
                                {
                                    <option value="@lesson.Id">@lesson.Title (@lesson.CreatedAt.ToShortDateString())</option>
                                }
                            </select>
                        </div>

                        @* 2. åˆ›å»ºæ–°è¯¾ç¨‹ *@
                        <div class="col-md-7">
                            <label class="form-label">æˆ–æ–°å»ºè¯¾ç¨‹ï¼š</label>
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="è¾“å…¥è¯¾ç¨‹æ ‡é¢˜..." @bind="newLessonTitle" />
                                <input type="text" class="form-control" placeholder="æè¿°(å¯é€‰)" @bind="newLessonDesc" />
                                <button class="btn btn-primary" type="button" @onclick="CreateLessonAsync">
                                    <span class="oi oi-plus"></span> æ–°å»ºå¹¶é€‰ä¸­
                                </button>
                            </div>
                        </div>
                    </div>
                    @if (currentMicroLessonId != null)
                    {
                        <div class="alert alert-success mt-2 mb-0 py-2">
                            å½“å‰å·²é€‰ä¸­è¯¾ç¨‹ IDï¼š<strong>@currentMicroLessonId</strong>ï¼Œæ¥ä¸‹æ¥çš„<strong>è§†é¢‘å½•åˆ¶</strong>å°†è‡ªåŠ¨å½’æ¡£åˆ°è¯¥è¯¾ç¨‹ä¸‹ã€‚
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h3>è§†é¢‘ç®¡ç†</h3>
                </div>
                <div class="card-body">
                    <h5>1. ä¸Šä¼ æœ¬åœ°è§†é¢‘</h5>
                    <InputFile OnChange="@HandleFileSelected" accept="video/*" class="form-control mb-3"/>

                    @if (selectedFile != null)
                    {
                        <div class="alert alert-light py-2">
                            <p class="mb-0"><strong>æ–‡ä»¶å:</strong> @selectedFile.Name</p>
                            <p class="mb-0"><strong>æ–‡ä»¶å¤§å°:</strong> @FormatFileSize(selectedFile.Size)</p>
                            <p class="mb-0"><strong>æ–‡ä»¶ç±»å‹:</strong> @selectedFile.ContentType</p>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(uploadMessage))
                    {
                        <div class="alert alert-@(uploadSuccess ? "success" : "danger")" role="alert">
                            @uploadMessage
                        </div>
                    }
                    @if (isUploading)
                    {
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar"
                                 style="width: 100%">
                                ä¸Šä¼ ä¸­...
                            </div>
                        </div>
                    }
                    <button class="btn btn-primary" @onclick="UploadFile"
                            disabled="@(selectedFile == null || isUploading)">
                        @(isUploading ? "ä¸Šä¼ ä¸­..." : "ä¸Šä¼ è§†é¢‘")
                    </button>

                    <hr/>

                    <h5>2. å½•åˆ¶è§†é¢‘æµ</h5>
                    <div class="mb-2">
                        <input class="form-control"
                               placeholder="è¾“å…¥æµåœ°å€ï¼Œä¾‹å¦‚ rtsp://admin:admin@172.30.1.4:554/stream/2"
                               @bind="streamUrl"/>
                    </div>

                    <div class="d-flex align-items-center flex-wrap">
                        <button class="btn btn-outline-primary me-2 mb-2" @onclick="() => OpenVideoStream(streamUrl)"
                                disabled="@string.IsNullOrWhiteSpace(streamUrl)">
                            <span class="oi oi-play-circle" aria-hidden="true"></span> æ‰“å¼€æµ
                        </button>
                        <button class="btn btn-success me-2 mb-2" @onclick="StartRecordingClicked"
                                disabled="@((string.IsNullOrWhiteSpace(streamUrl)) || isRecording)">
                            <span class="oi oi-media-record" aria-hidden="true"></span> å¼€å§‹å½•åˆ¶
                        </button>
                        <button class="btn btn-danger me-2 mb-2" @onclick="StopRecordingClicked"
                                disabled="@(!isRecording || currentRecordingId == null)">
                            <span class="oi oi-media-stop" aria-hidden="true"></span> åœæ­¢å½•åˆ¶
                        </button>

                        <span class="ms-auto mb-2 align-self-center">
                            @if (isRecording)
                            {
                                <span class="badge bg-danger">å½•åˆ¶ä¸­</span>
                            }
                            else if (currentRecordingId != null)
                            {
                                <span class="badge bg-secondary">å·²åœæ­¢ï¼ˆå¾…ä¿å­˜ï¼‰</span>
                            }
                        </span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3>å·²ä¸Šä¼ çš„è§†é¢‘</h3>
                    <button class="btn btn-secondary btn-sm" @onclick="LoadVideos">
                        <span class="oi oi-reload" aria-hidden="true"></span> åˆ·æ–°
                    </button>
                </div>
                <div class="card-body">
                    @if (videos == null)
                    {
                        <p><em>åŠ è½½ä¸­...</em></p>
                    }
                    else if (!videos.Any())
                    {
                        <p class="text-muted">æš‚æ— å·²ä¸Šä¼ çš„è§†é¢‘</p>
                    }
                    else
                    {
                        <div class="row">
                            @foreach (var video in videos)
                            {
                                <div class="col-md-4 mb-4">
                                    <div class="card h-100 d-flex flex-column">
                                        <div class="card-body">
                                            <h5 class="card-title">@video.FileName</h5>
                                            <video width="100%" controls>
                                                <source src="@video.FilePath" type="@video.ContentType">
                                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ ‡ç­¾ã€‚
                                            </video>
                                            <p class="card-text mt-2">
                                                <small class="text-muted">
                                                    ä¸Šä¼ æ—¶é—´: @video.UploadTime.ToString("yyyy-MM-dd HH:mm:ss")<br/>
                                                    æ–‡ä»¶å¤§å°: @FormatFileSize(video.FileSize)
                                                </small>
                                            </p>
                                        </div>

                                        <div class="card-footer mt-auto d-flex flex-wrap">

                                            <div>
                                                <button class="btn btn-warning btn-sm me-2 mb-2"
                                                        @onclick="() => StartCutting(video.Id)">
                                                    <span class="oi oi-cut" aria-hidden="true"></span> åˆ‡å‰²
                                                </button>
                                                <button class="btn btn-info btn-sm me-2 mb-2"
                                                        @onclick="() => StartConvertingToAudio(video.Id)">
                                                    <span class="oi oi-audio" aria-hidden="true"></span> è½¬æ¢ä¸ºéŸ³é¢‘
                                                </button>
                                                <button class="btn btn-success btn-sm me-2 mb-2"
                                                        @onclick="() => StartTranscribing(video.Id)">
                                                    <span class="oi oi-microphone" aria-hidden="true"></span> è½¬å½•
                                                </button>
                                            </div>

                                            <div class="ms-auto">
                                                <button class="btn btn-primary btn-sm me-2 mb-2"
                                                        @onclick="() => StartGeneratingSummaries(video.Id)">
                                                    <span class="oi oi-document" aria-hidden="true"></span> ç”Ÿæˆæ‘˜è¦
                                                </button>
                                                <button class="btn btn-secondary btn-sm me-2 mb-2"
                                                        @onclick="() => StartEvaluatingTeaching(video.Id)">
                                                    <span class="oi oi-bar-chart" aria-hidden="true"></span> æ•™å­¦è¯„ä¼°
                                                </button>
                                                <button class="btn btn-danger btn-sm mb-2"
                                                        @onclick="() => DeleteVideo(video.Id)">
                                                    <span class="oi oi-trash" aria-hidden="true"></span> åˆ é™¤
                                                </button>
                                                <button class="btn btn-outline-secondary btn-sm me-2 mb-2"
                                                        @onclick="() => DownloadEvaluation(video.Id)">
                                                    <span class="oi oi-cloud-download" aria-hidden="true"></span> ä¸‹è½½è¯„ä¼°
                                                </button>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private IBrowserFile? selectedFile;
    private List<VideoInfoDto> videos = new();
    private string uploadMessage = string.Empty;
    private bool uploadSuccess = false;
    private bool isUploading = false;
    private string streamUrl = string.Empty;
    private Guid? currentRecordingId = null;
    private bool isRecording = false;
    
    // ==========================================
    // è¯¾ç¨‹è®¾ç½®å˜é‡
    // ==========================================
    private List<MicroLesson> microLessons = new();
    
    // ä½¿ç”¨å¯ç©ºç±»å‹ ulong? ä»¥åŒ¹é…å‰ç«¯ <option value="">-- ä¸å…³è” --</option>
    private ulong? currentMicroLessonId; 
    
    private string newLessonTitle = string.Empty;
    private string newLessonDesc = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadMicroLessonsAsync();
        await LoadVideos();
    }
    
    // ==========================================
    // è¯¾ç¨‹è®¾ç½®é€»è¾‘ (Updated)
    // ==========================================
    private async Task LoadMicroLessonsAsync()
    {
        try 
        {
            microLessons = await MicroLessonService.GetMicroLessonsAsync();
            
            // é€»è¾‘é€‰æ‹©ï¼š
            // å¦‚æœä½ å¸Œæœ›é»˜è®¤é€‰ä¸­æœ€æ–°çš„è¯¾ç¨‹ï¼Œå¯ä»¥åœ¨è¿™é‡Œè®¾ç½®
            // å¦‚æœå¸Œæœ›é»˜è®¤ä¿æŒâ€œä¸å…³è”â€ï¼Œåˆ™ä¿æŒ currentMicroLessonId ä¸º null
            if (microLessons.Any() && currentMicroLessonId == null)
            {
                 // ç¤ºä¾‹ï¼šé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªï¼ˆå‡è®¾ Service è¿”å›æŒ‰æ—¶é—´å€’åºï¼‰
                 currentMicroLessonId = microLessons.First().Id;
            }
        }
        catch (Exception ex)
        {
             await JSRuntime.InvokeVoidAsync("alert", $"åŠ è½½è¯¾ç¨‹å¤±è´¥ï¼š{ex.Message}");
        }
    }

    // å¯¹åº”å‰ç«¯ @onclick="CreateLessonAsync"
    private async Task CreateLessonAsync()
    {
        if (string.IsNullOrWhiteSpace(newLessonTitle))
        {
            await JSRuntime.InvokeVoidAsync("alert", "è¯·è¾“å…¥è¯¾ç¨‹æ ‡é¢˜ã€‚");
            return;
        }

        try
        {
            // è°ƒç”¨ Service åˆ›å»ºæ¥å£ï¼Œä¼ å…¥æ ‡é¢˜å’Œæè¿°
            var result = await MicroLessonService.CreateMicroLessonAsync(newLessonTitle, newLessonDesc);
            
            if (result.Success)
            {
                await JSRuntime.InvokeVoidAsync("alert", "è¯¾ç¨‹åˆ›å»ºæˆåŠŸï¼");
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                newLessonTitle = string.Empty;
                newLessonDesc = string.Empty;
                
                // åˆ·æ–°åˆ—è¡¨
                await LoadMicroLessonsAsync();
                
                // è‡ªåŠ¨é€‰ä¸­åˆšåˆšåˆ›å»ºçš„è¯¾ç¨‹ (å‡è®¾å®ƒæ˜¯åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ª)
                if (microLessons.Any())
                {
                    currentMicroLessonId = microLessons.First().Id;
                }
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", $"åˆ›å»ºå¤±è´¥ï¼š{result.Message}");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"åˆ›å»ºå¼‚å¸¸ï¼š{ex.Message}");
        }
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        uploadMessage = string.Empty;
    }

    private async Task UploadFile()
    {
        if (selectedFile == null) return;

        try
        {
            isUploading = true;
            uploadMessage = string.Empty;
            StateHasChanged();

            // å–æ¶ˆå¤§å°é™åˆ¶
            var maxFileSize = long.MaxValue;

            using var stream = selectedFile.OpenReadStream(maxFileSize);
            var result = await VideoService.UploadVideoAsync(selectedFile.Name, stream, selectedFile.ContentType, currentMicroLessonId);

            if (result.Success)
            {
                uploadMessage = "è§†é¢‘ä¸Šä¼ æˆåŠŸï¼";
                uploadSuccess = true;
                selectedFile = null;
                await LoadVideos();
            }
            else
            {
                uploadMessage = $"ä¸Šä¼ å¤±è´¥ï¼š{result.Message}";
                uploadSuccess = false;
            }
        }
        catch (Exception ex)
        {
            uploadMessage = $"ä¸Šä¼ å‡ºé”™ï¼š{ex.Message}";
            uploadSuccess = false;
        }
        finally
        {
            isUploading = false;
            StateHasChanged();
        }
    }

    private async Task LoadVideos()
    {
        videos = await VideoService.GetAllVideosAsync();
        StateHasChanged();
    }

    private async Task DeleteVideo(ulong id)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§†é¢‘å—ï¼Ÿ");
        if (confirmed)
        {
            var result = await VideoService.DeleteVideoAsync(id);
            if (result.Success)
            {
                await LoadVideos();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", $"åˆ é™¤å¤±è´¥ï¼š{result.Message}");
            }
        }
    }

    private async Task StartCutting(ulong videoId)
    {
        try
        {
            var result = await VideoService.CutVideoAsync(videoId);
            if (result.Success)
            {
                await JSRuntime.InvokeVoidAsync("alert", "è§†é¢‘åˆ‡å‰²å®Œæˆï¼");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", $"åˆ‡å‰²å¤±è´¥ï¼š{result.Message}");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"åˆ‡å‰²å‡ºé”™ï¼š{ex.Message}");
        }
    }

    private async Task StartConvertingToAudio(ulong videoId)
    {
        try
        {
            // 1. åªéœ€è°ƒç”¨æœåŠ¡å±‚çš„æ–¹æ³•
            var result = await AudioService.ConvertAllSegmentsForVideoAsync(videoId);

            // 2. æ ¹æ®è¿”å›çš„ç»“æœå¯¹è±¡ï¼Œæ ¼å¼åŒ–UIæ¶ˆæ¯
            string finalMessage;
            if (result.TotalFiles == 0)
            {
                finalMessage = "æ²¡æœ‰æ‰¾åˆ°å¯è½¬æ¢çš„è§†é¢‘ã€‚";
            }
            else
            {
                finalMessage = $"è½¬æ¢å®Œæˆï¼\næ€»æ•°: {result.TotalFiles} ä¸ª\næˆåŠŸ: {result.SuccessCount} ä¸ª\nå¤±è´¥: {result.FailureCount} ä¸ª";
                if (result.FailedMessages.Any())
                {
                    // æŠŠè¯¦ç»†é”™è¯¯ä¿¡æ¯ä¹Ÿå±•ç¤ºå‡ºæ¥
                    finalMessage += "\n\nå¤±è´¥è¯¦æƒ…:\n" + string.Join("\n", result.FailedMessages);
                }
            }

            // 3. æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            await JSRuntime.InvokeVoidAsync("alert", finalMessage);
        }
        catch (Exception ex)
        {
            // æ•è·æœåŠ¡å±‚å¯èƒ½æŠ›å‡ºçš„æ„å¤–å¼‚å¸¸
            await JSRuntime.InvokeVoidAsync("alert", $"ç¨‹åºå‘ç”Ÿä¸¥é‡é”™è¯¯ï¼š{ex.Message}");
        }
    }

    private async Task StartTranscribing(ulong videoId)
    {
        try
        {
            var result = await AudioService.TranscribeAllSegmentsForVideoAsync(videoId);

            string finalMessage;
            if (result.TotalFiles == 0)
            {
                finalMessage = "æ²¡æœ‰æ‰¾åˆ°å¯è½¬å½•çš„ç‰‡æ®µã€‚";
            }
            else
            {
                finalMessage = $"è½¬å½•å®Œæˆï¼\næ€»æ•°: {result.TotalFiles} ä¸ª\næˆåŠŸ: {result.SuccessCount} ä¸ª\nå¤±è´¥: {result.FailureCount} ä¸ª";
                if (result.FailedMessages.Any())
                {
                    finalMessage += "\n\nå¤±è´¥è¯¦æƒ…:\n" + string.Join("\n", result.FailedMessages);
                }
            }

            await JSRuntime.InvokeVoidAsync("alert", finalMessage);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"è½¬å½•å‡ºé”™ï¼š{ex.Message}");
        }
    }

    private async Task StartGeneratingSummaries(ulong videoId)
    {
        try
        {
            var result = await SummaryService.GenerateSummariesForVideoAsync(videoId);
            string finalMessage;
            if (result.TotalFiles == 0)
            {
                finalMessage = "æ²¡æœ‰æ‰¾åˆ°è½¬å½•è®°å½•ã€‚";
            }
            else
            {
                finalMessage = $"æ‘˜è¦ç”Ÿæˆå®Œæˆï¼\næ€»æ•°: {result.TotalFiles} ä¸ª\næˆåŠŸ: {result.SuccessCount} ä¸ª\nå¤±è´¥: {result.FailureCount} ä¸ª";
                if (result.FailedMessages.Any())
                {
                    finalMessage += "\n\nå¤±è´¥è¯¦æƒ…:\n" + string.Join("\n", result.FailedMessages);
                }
            }

            await JSRuntime.InvokeVoidAsync("alert", finalMessage);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"ç”Ÿæˆæ‘˜è¦å‡ºé”™ï¼š{ex.Message}");
        }
    }

    private async Task StartEvaluatingTeaching(ulong videoId)
    {
        try
        {
            var result = await ClassroomEvaluationService.EvaluateAndSaveReportForVideoAsync(videoId);
            if (result.Success)
            {
                await JSRuntime.InvokeVoidAsync("alert", result.Message);
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", $"è¯„ä¼°å¤±è´¥ï¼š{result.Message}");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"è¯„ä¼°å‡ºé”™ï¼š{ex.Message}");
        }
    }


    private async Task OpenVideoStream(string filePath)
    {
        try
        {
            if (string.IsNullOrWhiteSpace(filePath)) return;

            // æ”¯æŒ rtmp/rtmps ç›´è¿ï¼ˆç›´æ¥åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ï¼‰
            if (filePath.StartsWith("rtmp://", StringComparison.OrdinalIgnoreCase) ||
                filePath.StartsWith("rtmps://", StringComparison.OrdinalIgnoreCase))
            {
                await JSRuntime.InvokeVoidAsync("open", filePath, "_blank");
                return;
            }

            // å…¶ä»–ï¼ˆhttp(s) æˆ– ç›¸å¯¹è·¯å¾„ï¼‰ä¿æŒåŸæœ‰æ‰“å¼€é€»è¾‘
            await JSRuntime.InvokeVoidAsync("open", filePath, "_blank");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"æ‰“å¼€è§†é¢‘æµå¤±è´¥ï¼š{ex.Message}");
        }
    }

    private async Task StartRecordingClicked()
    {
        if (string.IsNullOrWhiteSpace(streamUrl))
        {
            await JSRuntime.InvokeVoidAsync("alert", "è¯·è¾“å…¥æµåœ°å€åå†å¼€å§‹å½•åˆ¶ã€‚");
            return;
        }

        var result = await VideoService.StartRecordingAsync(streamUrl, currentMicroLessonId);
        if (!result.Success)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"å¼€å§‹å½•åˆ¶å¤±è´¥ï¼š{result.Message}");
            return;
        }

        // å°è¯•ä»è¿”å›æ•°æ®ä¸­æå– RecordingIdï¼ˆå…¼å®¹åŒ¿åå¯¹è±¡æˆ– JsonElementï¼‰
        Guid parsedId;
        var gotId = false;

        if (result.Data is JsonElement je)
        {
            if (je.ValueKind == JsonValueKind.Object && je.TryGetProperty("RecordingId", out var rid) && rid.ValueKind == JsonValueKind.String && Guid.TryParse(rid.GetString(), out parsedId))
            {
                currentRecordingId = parsedId;
                gotId = true;
            }
            else if (je.ValueKind == JsonValueKind.String && Guid.TryParse(je.GetString(), out parsedId))
            {
                currentRecordingId = parsedId;
                gotId = true;
            }
        }
        else if (result.Data != null)
        {
            try
            {
                var json = JsonSerializer.Serialize(result.Data);
                using var doc = JsonDocument.Parse(json);
                if (doc.RootElement.TryGetProperty("RecordingId", out var rid) && rid.ValueKind == JsonValueKind.String && Guid.TryParse(rid.GetString(), out parsedId))
                {
                    currentRecordingId = parsedId;
                    gotId = true;
                }
            }
            catch
            {
                // å¿½ç•¥è§£æå¼‚å¸¸
            }
        }

        isRecording = true;
        var msg = gotId ? "å·²å¼€å§‹å½•åˆ¶ã€‚" : "å·²å¼€å§‹å½•åˆ¶ï¼ˆæœªè·å–åˆ°å½•åˆ¶IDï¼Œå¯èƒ½æ— æ³•åœæ­¢ï¼‰ã€‚";
        await JSRuntime.InvokeVoidAsync("alert", msg);
    }

    private async Task StopRecordingClicked()
    {
        if (!isRecording || currentRecordingId == null)
        {
            await JSRuntime.InvokeVoidAsync("alert", "å½“å‰æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„å½•åˆ¶ã€‚");
            return;
        }

        var result = await VideoService.StopRecordingAsync(currentRecordingId.Value);
        if (!result.Success)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"åœæ­¢å½•åˆ¶å¤±è´¥ï¼š{result.Message}");
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", "åœæ­¢å½•åˆ¶å¹¶ä¿å­˜æˆåŠŸã€‚");
            await LoadVideos();
        }

        // é‡ç½®çŠ¶æ€
        currentRecordingId = null;
        isRecording = false;
    }

    private async Task DownloadEvaluation(ulong videoId)
    {
        try
        {
            var relativePath = await ClassroomEvaluationService.GetEvaluationReportForVideoAsync(videoId);
            if (string.IsNullOrWhiteSpace(relativePath))
            {
                await JSRuntime.InvokeVoidAsync("alert", "æœªæ‰¾åˆ°è¯„ä¼°æŠ¥å‘Šã€‚");
                return;
            }

            var fileName = Path.GetFileName(relativePath);
            if (string.IsNullOrWhiteSpace(fileName))
            {
                fileName = $"evaluation_{videoId}.md";
            }

            // ä½¿ç”¨åœ¨ `/wwwroot/js/site.js` ä¸­å®šä¹‰çš„å…¨å±€å‡½æ•°è¿›è¡Œä¸‹è½½
            await JSRuntime.InvokeVoidAsync("forceDownload", relativePath, fileName);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"ä¸‹è½½è¯„ä¼°å‡ºé”™ï¼š{ex.Message}");
        }
            
    }
        

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }

        return $"{len:0.##} {sizes[order]}";
    }

}
