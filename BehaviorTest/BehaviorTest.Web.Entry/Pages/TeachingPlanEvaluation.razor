@page "/teachingplanevaluation"
@using BehaviorTest.Application.RBAC.Entity
@inject IJSRuntime JSRuntime
@inject IDesignEvaluationService _DesignEvaluationService
@inject IMicroLessonService MicroLessonService 

<PageTitle>导学案上传与评价</PageTitle>

<h1>导学案上传与教学设计评价</h1>

<div class="container">

    @* ========================================== *@
    @* 🆕 新增区域：课程/微课设置 *@
    @* ========================================== *@
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h3 class="mb-0">📚 课程设置</h3>
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-center">
                        @* 1. 选择已有课程 *@
                        <div class="col-md-5">
                            <label class="form-label">选择当前课程（将与录制的视频关联）：</label>
                            <select class="form-select" @bind="currentMicroLessonId">
                                <option value="">-- 不关联特定课程 --</option>
                                @foreach (var lesson in microLessons)
                                {
                                    <option value="@lesson.Id">@lesson.Title (@lesson.CreatedAt.ToShortDateString())</option>
                                }
                            </select>
                        </div>

                        @* 2. 创建新课程 *@
                        <div class="col-md-7">
                            <label class="form-label">或新建课程：</label>
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="输入课程标题..." @bind="newLessonTitle" />
                                <input type="text" class="form-control" placeholder="描述(可选)" @bind="newLessonDesc" />
                                <button class="btn btn-primary" type="button" @onclick="CreateLessonAsync">
                                    <span class="oi oi-plus"></span> 新建并选中
                                </button>
                            </div>
                        </div>
                    </div>
                    @if (currentMicroLessonId != null)
                    {
                        <div class="alert alert-success mt-2 mb-0 py-2">
                            当前已选中课程 ID：<strong>@currentMicroLessonId</strong>，接下来的<strong>教学设计</strong>将自动归档到该课程下。
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- 顶部：上传区域 + 当前选中导学案信息 -->
    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3>导学案上传</h3>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        请上传 <strong>Word 教学设计（.docx）</strong>，系统将把文件保存到
                        <code>wwwroot/teachingplan</code> 目录，并写入数据库。
                    </p>

                    <!-- 选择本地文件 -->
                    <InputFile OnChange="OnFileSelected" accept=".docx" />
                    @if (selectedFileName is not null)
                    {
                        <p class="mt-2">
                            已选择本地文件：<strong>@selectedFileName</strong>
                        </p>
                    }

                    <!-- 上传按钮 -->
                    <div class="mt-3 d-flex flex-wrap align-items-center">
                        <button class="btn btn-primary me-2 mb-2"
                                @onclick="UploadTeachingPlanAsync"
                                disabled="@(!canUpload)">
                            <span class="oi oi-cloud-upload" aria-hidden="true"></span>
                            @if (isUploading)
                            {
                                <span> 正在上传...</span>
                            }
                            else
                            {
                                <span> 上传导学案</span>
                            }
                        </button>
                    </div>

                    <!-- 状态提示 -->
                    @if (!string.IsNullOrWhiteSpace(statusMessage))
                    {
                        <div class="alert @(uploadSuccess ? "alert-success" : "alert-warning") mt-3" role="alert">
                            @statusMessage
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- 右侧：评分结果展示 -->
        <div class="col-md-4 mt-3 mt-md-0">
            <div class="card">
                <div class="card-header">
                    <h3>评分结果</h3>
                </div>
                <div class="card-body">
                    @if (evaluationResult is null)
                    {
                        <p class="text-muted">尚未进行评价。</p>
                    }
                    else
                    {
                        <p class="text-muted">
                            当前显示的是导学案：
                            <strong>@selectedLessonPlanName</strong>
                        </p>

                        <ul class="list-group mb-3">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                总分（0-100）
                                <span class="badge bg-primary rounded-pill">@evaluationResult.TotalScore</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                教学理念与目标（0-25）
                                <span class="badge bg-secondary rounded-pill">@evaluationResult.PhilosophyScore</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                教学内容（0-25）
                                <span class="badge bg-secondary rounded-pill">@evaluationResult.ContentScore</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                教学过程设计（0-25）
                                <span class="badge bg-secondary rounded-pill">@evaluationResult.ProcessScore</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                教学效果预期（0-25）
                                <span class="badge bg-secondary rounded-pill">@evaluationResult.EffectScore</span>
                            </li>
                        </ul>

                        <h5>综合评语</h5>
                        <p style="white-space: pre-wrap;">@evaluationResult.Comment</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- 下方：已上传导学案表格 -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3>已上传导学案</h3>
                    <button class="btn btn-sm btn-secondary" @onclick="LoadLessonPlansAsync">
                        <span class="oi oi-reload" aria-hidden="true"></span> 刷新
                    </button>
                </div>
                <div class="card-body">
                    @if (lessonPlans is null)
                    {
                        <p class="text-muted">加载中...</p>
                    }
                    else if (!lessonPlans.Any())
                    {
                        <p class="text-muted">暂无导学案，请先上传。</p>
                    }
                    else
                    {
                        <table class="table table-striped table-hover">
                            <thead>
                            <tr>
                                <th style="width: 60px;">ID</th>
                                <th>文件名</th>
                                <th style="width: 200px;">上传时间</th>
                                <th>路径</th>
                                <th style="width: 220px;">操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            @foreach (var plan in lessonPlans)
                            {
                                <tr class="@(selectedLessonPlanPath == plan.SourcePath ? "table-active" : "")">
                                    <td>@plan.Id</td>
                                    <td>@plan.OriginalName</td>
                                    <td>@plan.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>
                                        <code>@plan.SourcePath</code>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-success me-2"
                                                @onclick="() => EvaluateLessonPlanAsync(plan)"
                                                disabled="@isEvaluating">
                                            <span class="oi oi-bar-chart" aria-hidden="true"></span> 评估
                                        </button>
                                        
                                        <button class="btn btn-sm btn-outline-info me-2"
                                                @onclick="() => DownloadEvaluationReportAsync(plan)">
                                            <span class="oi oi-cloud-download" aria-hidden="true"></span> 下载评估
                                        </button>

                                        @*<a class="btn btn-sm btn-outline-primary"
                                           href="@($"/{plan.SourcePath}")" target="_blank">
                                            <span class="oi oi-eye" aria-hidden="true"></span> 查看
                                        </a>*@
                                        
                                        
                                    </td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        </div>
    </div>

</div>

@code {
    private IBrowserFile? selectedFile;
    private string? selectedFileName;

    // 已上传导学案列表
    private List<LessonPlanListItemDto>? lessonPlans;

    // 当前正在评估/显示的教案信息
    private string? selectedLessonPlanPath;
    private string? selectedLessonPlanName;

    private bool isUploading = false;
    private bool isEvaluating = false;
    private bool uploadSuccess = false;
    private string statusMessage = string.Empty;
    private EvaluationResultDto? evaluationResult;

    private bool canUpload => selectedFile is not null && !isUploading;
    
    // ==========================================
    // 3. 课程设置变量
    // ==========================================
    private List<MicroLesson> microLessons = new();
    
    // 使用可空类型 ulong? 以匹配前端 <option value="">-- 不关联 --</option>
    private ulong? currentMicroLessonId; 
    
    private string newLessonTitle = string.Empty;
    private string newLessonDesc = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadMicroLessonsAsync(); // 加载课程列表
        await LoadLessonPlansAsync();
    }
    
    // ==========================================
    // 课程设置逻辑 (Updated)
    // ==========================================
    private async Task LoadMicroLessonsAsync()
    {
        try 
        {
            microLessons = await MicroLessonService.GetMicroLessonsAsync();
            
            // 逻辑选择：
            // 如果你希望默认选中最新的课程，可以在这里设置
            // 如果希望默认保持“不关联”，则保持 currentMicroLessonId 为 null
            if (microLessons.Any() && currentMicroLessonId == null)
            {
                 // 示例：默认选中第一个（假设 Service 返回按时间倒序）
                 currentMicroLessonId = microLessons.First().Id;
            }
        }
        catch (Exception ex)
        {
             await JSRuntime.InvokeVoidAsync("alert", $"加载课程失败：{ex.Message}");
        }
    }

    // 对应前端 @onclick="CreateLessonAsync"
    private async Task CreateLessonAsync()
    {
        if (string.IsNullOrWhiteSpace(newLessonTitle))
        {
            await JSRuntime.InvokeVoidAsync("alert", "请输入课程标题。");
            return;
        }

        try
        {
            // 调用 Service 创建接口，传入标题和描述
            var result = await MicroLessonService.CreateMicroLessonAsync(newLessonTitle, newLessonDesc);
            
            if (result.Success)
            {
                await JSRuntime.InvokeVoidAsync("alert", "课程创建成功！");
                
                // 清空输入框
                newLessonTitle = string.Empty;
                newLessonDesc = string.Empty;
                
                // 刷新列表
                await LoadMicroLessonsAsync();
                
                // 自动选中刚刚创建的课程 (假设它是列表中的第一个)
                if (microLessons.Any())
                {
                    currentMicroLessonId = microLessons.First().Id;
                }
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", $"创建失败：{result.Message}");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"创建异常：{ex.Message}");
        }
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        selectedFileName = selectedFile?.Name;

        statusMessage = string.Empty;
        uploadSuccess = false;
        // 不清空 lessonPlans，让表格保持
        // 不清空 evaluationResult，保留上次评估结果
    }

    /// <summary>
    /// 上传导学案到 wwwroot/teachingplan，并写入 lesson_plans 表
    /// </summary>
    private async Task UploadTeachingPlanAsync()
    {
        if (selectedFile is null)
        {
            await JSRuntime.InvokeVoidAsync("alert", "请先选择一个 .docx 导学案文件。");
            return;
        }

        isUploading = true;
        statusMessage = "正在上传导学案，请稍候...";
        uploadSuccess = false;
        StateHasChanged();

        try
        {
            // 服务内部会：
            // 1. 保存文件到 wwwroot/teachingplan
            // 2. 写入 lesson_plans 表
            var relativePath = await _DesignEvaluationService.UploadTeachingPlanAsync(selectedFile, currentMicroLessonId ?? 1);

            uploadSuccess = true;
            statusMessage = $"导学案上传成功，路径：{relativePath}";

            // 上传后刷新列表
            await LoadLessonPlansAsync();
        }
        catch (Exception ex)
        {
            statusMessage = $"上传出错：{ex.Message}";
            uploadSuccess = false;
        }
        finally
        {
            isUploading = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// 从后端加载所有导学案列表
    /// </summary>
    private async Task LoadLessonPlansAsync()
    {
        try
        {
            lessonPlans = await _DesignEvaluationService.GetLessonPlansAsync();
        }
        catch (Exception ex)
        {
            lessonPlans = new List<LessonPlanListItemDto>();
            await JSRuntime.InvokeVoidAsync("alert", $"加载导学案列表失败：{ex.Message}");
        }

        StateHasChanged();
    }

    /// <summary>
    /// 对指定导学案进行评估。
    /// 后端服务负责将评估结果保存到 wwwroot/teachingplan/evaluations 目录。
    /// </summary>
    private async Task EvaluateLessonPlanAsync(LessonPlanListItemDto plan)
    {
        try
        {
            isEvaluating = true;
            statusMessage = $"正在评估导学案：{plan.OriginalName}...";
            selectedLessonPlanPath = plan.SourcePath;
            selectedLessonPlanName = plan.OriginalName;
            evaluationResult = null;
            StateHasChanged();

            // EvaluateDesignAsync 内部应：
            // 1. 读取 wwwroot/teachingplan 下的 Word 文件
            // 2. 调用大模型打分
            // 3. 将评估报告写入 wwwroot/teachingplan/evaluations 目录
            // 4. 在 evaluations 表插入一条 phase_type = 'LessonPlan' 的记录
            var result = await _DesignEvaluationService.EvaluateDesignAsync(plan.SourcePath);

            evaluationResult = result;
            statusMessage = $"导学案「{plan.OriginalName}」评估完成，报告已保存到 wwwroot/teachingplan/evaluations 目录。";
        }
        catch (Exception ex)
        {
            statusMessage = $"评估出错：{ex.Message}";
        }
        finally
        {
            isEvaluating = false;
            StateHasChanged();
        }
    }
    
    
    /// <summary>
    /// 下载指定导学案的评估报告
    /// </summary>
    private async Task DownloadEvaluationReportAsync(LessonPlanListItemDto plan)
    {
        try
        {
            // 调用 Service 获取报告路径 (需要在 Service 中实现此方法)
            var relativePath = await _DesignEvaluationService.GetEvaluationReportPathAsync(plan.Id);

            if (string.IsNullOrWhiteSpace(relativePath))
            {
                await JSRuntime.InvokeVoidAsync("alert", "未找到该导学案的评估报告（请先进行评估）。");
                return;
            }

            var fileName = Path.GetFileName(relativePath);
            
            // 使用全局下载函数 (wwwroot/js/site.js)
            await JSRuntime.InvokeVoidAsync("forceDownload", relativePath, fileName);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"下载出错：{ex.Message}");
        }
    }
}
