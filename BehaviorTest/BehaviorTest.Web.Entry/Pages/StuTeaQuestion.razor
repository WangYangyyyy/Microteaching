@page "/classteaquestion"
@using System.Text.Json
@using BehaviorTest.Application.RBAC.Entity
@inject IJSRuntime JS
@inject IQuestionAnswerService QuestionAnswerService
@inject IQaEvaluationService QaEvaluationService

<h3>ğŸ™ï¸ è¯­éŸ³è¯¾å ‚ï¼ˆå”¤é†’è¯è§¦å‘ä¸‰å­¦ç”Ÿå›ç­”ï¼‰</h3>

<div style="margin:10px 0; padding:10px; background:#fff; border-radius:8px;">
  <b>çŠ¶æ€ï¼š</b> @Status
</div>

<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
  <label>åç«¯ API Baseï¼š</label>
  <input style="width:280px" @bind="ApiBase"/>

  <label>å”¤é†’è¯ï¼š</label>
  <input style="width:180px" @bind="WakeWord" placeholder="ä¾‹å¦‚ï¼šåŒå­¦è¯·å›ç­”"/>

  <label>åˆ‡æ®µæ—¶é•¿(ms)ï¼š</label>
  <input style="width:120px" type="number" @bind="SilenceMs"/>

  <label>éŸ³é‡é˜ˆå€¼ï¼š</label>
  <input style="width:90px" type="number" @bind="VolumeThreshold" min="1" max="200"/>

  <label>è‡ªé€‚åº”é˜ˆå€¼ï¼š</label>
  <input type="checkbox" @bind="UseAdaptiveThreshold" />

  <button @onclick="Start">å¼€å§‹</button>
  <button @onclick="Stop">åœæ­¢</button>
</div>

<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
  <label>åº•å™ªé‡‡æ ·(ms)ï¼š</label>
  <input style="width:90px" type="number" @bind="NoiseSampleMs" min="200" max="3000"/>

  <label>åº•å™ªè£•åº¦ï¼š</label>
  <input style="width:90px" type="number" @bind="NoiseMargin" min="1" max="50"/>

  <label>æœ€çŸ­å½•éŸ³(ms)ï¼š</label>
  <input style="width:100px" type="number" @bind="MinRecordMs" min="200" max="5000"/>

  <label>è¿ç»­é™éŸ³å¸§ï¼š</label>
  <input style="width:90px" type="number" @bind="SilentFrames" min="3" max="30"/>

  <label>å¹³æ»‘çª—å£ï¼š</label>
  <input style="width:90px" type="number" @bind="SmoothWindow" min="1" max="10"/>
</div>

<div style="max-width:900px; background:#fff; border-radius:8px; padding:15px; height:420px; overflow:auto;">
  @foreach (var m in Messages)
  {
    <div style="@GetMsgStyle(m.Kind)">
      <div style="font-weight:bold; margin-bottom:4px;">@m.Title</div>
      <div>@m.Text</div>
    </div>
  }
</div>

<div style="margin-top:10px; color:#666;">
  <div>æç¤ºï¼šè¯·è¯´ï¼š<b>@WakeWordï¼šä½ çš„é—®é¢˜</b>ï¼ˆä¾‹å¦‚ï¼šåŒå­¦è¯·å›ç­”ï¼šç‰›é¡¿ç¬¬ä¸€å®šå¾‹æ˜¯ä»€ä¹ˆï¼Ÿï¼‰</div>
  <div>ASR åŸæ–‡ä¹Ÿä¼šæ˜¾ç¤ºï¼Œæ–¹ä¾¿ä½ è°ƒè¯•å”¤é†’è¯ã€‚</div>
</div>

<h4 style="margin-top:20px;">é—®ç­”è®°å½•</h4>
<div style="margin:10px 0; display:flex; gap:10px; align-items:center;">
  <label>æ‹‰å–æ¡æ•°ï¼š</label>
  <input type="number" style="width:80px" @bind="TakeCount" min="1" max="100"/>
  <button @onclick="LoadRecent">åˆ·æ–°</button>
  <button @onclick="() => SendToLlm(null)" disabled="@IsEvaluating">@(IsEvaluating ? "è¯„ä¼°ä¸­..." : "å‘é€åˆ°LLMè¯„ä¼°")</button>
  <span style="color:#666;">å…± @RecentRecords.Count æ¡</span>
</div>

<div style="background:#fff; border-radius:8px; padding:12px; max-width:900px;">
  <table class="table">
    <thead>
    <tr>
      <th>ID</th>
      <th>Session</th>
      <th>é—®é¢˜</th>
      <th>æ—¶é—´</th>
      <th>å›ç­”æ•°</th>
      <th>æ“ä½œ</th>
    </tr>
    </thead>
    <tbody>
    @foreach (var r in RecentRecords)
    {
      <tr>
        <td>@r.Id</td>
        <td>@(r.SessionId?.ToString() ?? "-")</td>
        <td>@r.Question</td>
        <td>@r.AskedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</td>
        <td>@r.Answers.Count</td>
        <td>
          <button @onclick="() => ToggleAnswers(r.Id)">@(Expanded.Contains(r.Id) ? "æ”¶èµ·" : "æŸ¥çœ‹")</button>
          <button style="margin-left:6px;" @onclick="() => SendToLlm(r.Id)" disabled="@IsEvaluating">è¯„ä¼°</button>
        </td>
      </tr>
      @if (Expanded.Contains(r.Id))
      {
        <tr>
          <td colspan="6" style="background:#f9f9f9;">
            @if (r.Answers.Count == 0)
            {
              <div style="color:#999;">æš‚æ— å›ç­”</div>
            }
            else
            {
              <ul style="margin:0; padding-left:18px;">
                @foreach (var a in r.Answers)
                {
                  <li><b>@(a.Name ?? "å­¦ç”Ÿ")</b> (@(a.Role ?? "è§’è‰²"))ï¼š@a.Answer</li>
                }
              </ul>
            }
          </td>
        </tr>
      }
    }
    </tbody>
  </table>
</div>

@if (!string.IsNullOrWhiteSpace(EvalMessage))
{
  <div style="margin-top:10px; color:#999;">@EvalMessage</div>
}

@if (!string.IsNullOrWhiteSpace(EvalResult))
{
  <div style="margin-top:10px; background:#f8f9fa; padding:12px; border-radius:6px; white-space:pre-wrap;">
    @EvalResult
  </div>
}

@code {
  private IJSObjectReference? _module;
  private DotNetObjectReference<StuTeaQuestion>? _dotNetRef;

  public string ApiBase { get; set; } = "http://118.230.212.160:9010";
  public string WakeWord { get; set; } = "åŒå­¦";
  public int SilenceMs { get; set; } = 1800;
  public int VolumeThreshold { get; set; } = 2;
  public bool UseAdaptiveThreshold { get; set; } = true;
  public int NoiseSampleMs { get; set; } = 1000;
  public int NoiseMargin { get; set; } = 2;
  public int MinRecordMs { get; set; } = 1200;
  public int SilentFrames { get; set; } = 10;
  public int SmoothWindow { get; set; } = 5;
  public int SessionId { get; set; } = 0;

  public string Status { get; set; } = "æœªå¼€å§‹";

  public List<ChatMsg> Messages { get; set; } = new();
  private string? _currentQuestion;
  private DateTime _currentQuestionAt = DateTime.UtcNow;

  private int TakeCount { get; set; } = 20;
  private List<QaRecordView> RecentRecords { get; set; } = new();
  private HashSet<ulong> Expanded { get; set; } = new();

  private bool IsEvaluating { get; set; }
  private string EvalResult { get; set; } = "";
  private string EvalMessage { get; set; } = "";

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (firstRender)
    {
      _module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/classroomAudio.js");
      _dotNetRef = DotNetObjectReference.Create(this);
      await LoadRecent();
    }
  }

  private async Task Start()
  {
    if (_module is null || _dotNetRef is null) return;

    Messages.Add(new ChatMsg("system", "ç³»ç»Ÿ", "å¼€å§‹ç›‘å¬ï¼ˆéœ€è¦éº¦å…‹é£æƒé™ï¼‰"));

    // âœ… æ–°ç‰ˆ classroomAudio.jsï¼šç¬¬ 6 ä¸ªå‚æ•°å¼€å§‹ç”¨ options å¯¹è±¡ä¼ é…ç½®
    var options = new
    {
      SilenceMs = SilenceMs,
      VolumeThreshold = VolumeThreshold,
      UseAdaptiveThreshold = UseAdaptiveThreshold,
      NoiseSampleMs = NoiseSampleMs,
      NoiseMargin = NoiseMargin,
      MinRecordMs = MinRecordMs,
      SilentFrames = SilentFrames,
      SmoothWindow = SmoothWindow
    };

    await _module.InvokeVoidAsync(
      "startClassroomLoop",
      _dotNetRef,
      ApiBase,
      WakeWord,
      SilenceMs,
      SessionId,
      options
    );
  }

  private async Task Stop()
  {
    if (_module is null) return;
    await _module.InvokeVoidAsync("stopClassroomLoop");
    Status = "å·²åœæ­¢";
    Messages.Add(new ChatMsg("system", "ç³»ç»Ÿ", "å·²åœæ­¢ç›‘å¬"));
    StateHasChanged();
  }

  private string GetMsgStyle(string kind)
  {
    var baseStyle = "margin-bottom:10px; padding:10px; border-radius:6px;";
    return kind switch
    {
      "teacher" => baseStyle + " background:#e3f2fd; border-left:4px solid #4361ee;",
      "student" => baseStyle + " background:#f1f8e9; border-left:4px solid #8bc34a;",
      "error" => baseStyle + " background:#ffebee; border-left:4px solid #e53935;",
      _ => baseStyle + " background:#f5f5f5; border-left:4px solid #999;",
    };
  }

  // ===== JS å›è°ƒï¼ˆå¿…é¡» public + [JSInvokable]ï¼‰ =====

  [JSInvokable]
  public Task SetStatus(string s)
  {
    Status = s;
    InvokeAsync(StateHasChanged);
    return Task.CompletedTask;
  }

  [JSInvokable]
  public Task OnAsrRaw(string raw)
  {
    if (!string.IsNullOrWhiteSpace(raw))
      Messages.Add(new ChatMsg("system", "ASRåŸæ–‡", raw));
    InvokeAsync(StateHasChanged);
    return Task.CompletedTask;
  }

  [JSInvokable]
  public Task OnTeacherQuestion(string question)
  {
    Messages.Add(new ChatMsg("teacher", "è€å¸ˆæé—®", question));
    _currentQuestion = question;
    _currentQuestionAt = DateTime.UtcNow;
    InvokeAsync(StateHasChanged);
    return Task.CompletedTask;
  }

  // JS é‡Œä¼ è¿‡æ¥çš„æ˜¯æ•°ç»„å¯¹è±¡ï¼ŒBlazor ä¼šæŒ‰ JsonElement æ¥æ”¶æœ€ç¨³
  [JSInvokable]
  public async Task OnStudentAnswers(JsonElement answers)
  {
    var collected = new List<StudentAnswerDto>();
    // âœ… 1. å®šä¹‰ä¸€ä¸ªåˆ—è¡¨ä¸“é—¨å­˜éŸ³é¢‘
    var audioList = new List<string>(); 

    if (answers.ValueKind == JsonValueKind.Array)
    {
      foreach (var a in answers.EnumerateArray())
      {
        var name = a.TryGetProperty("name", out var n) ? n.GetString() : "å­¦ç”Ÿ";
        var role = a.TryGetProperty("role", out var r) ? r.GetString() : "";
        var ans = a.TryGetProperty("answer", out var c) ? c.GetString() : "";
        
        // âœ… 2. æå–åç«¯è¿”å›çš„éŸ³é¢‘æ•°æ®
        var audio = a.TryGetProperty("audio_base64", out var au) ? au.GetString() : "";

        Messages.Add(new ChatMsg("student", $"{name}ï¼ˆ{role}ï¼‰", ans ?? ""));
        
        // âœ… 3. å¦‚æœæœ‰éŸ³é¢‘ï¼ŒåŠ å…¥æ’­æ”¾åˆ—è¡¨
        if (!string.IsNullOrEmpty(audio)) 
        {
            audioList.Add(audio);
        }

        collected.Add(new StudentAnswerDto
        {
          Name = name,
          Role = role,
          Answer = ans
          // æ³¨æ„ï¼šé€šå¸¸ä¸æŠŠ Audio_Base64 å­˜å…¥æ•°æ®åº“ï¼Œå› ä¸ºå¤ªå ç©ºé—´ï¼Œè¿™é‡Œå°±ä¸èµ‹å€¼ç»™ collected äº†
        });
      }
    }

    // âœ… 4. è°ƒç”¨ JS æ’­æ”¾å£°éŸ³
    if (audioList.Count > 0 && _module is not null)
    {
        await _module.InvokeVoidAsync("playStudentAudios", audioList);
    }

    // --- ä¸‹é¢æ˜¯åŸæœ¬çš„ä¿å­˜é€»è¾‘ï¼Œä¿æŒä¸å˜ ---
    if (!string.IsNullOrWhiteSpace(_currentQuestion))
    {
      try
      {
        var saveResult = await QuestionAnswerService.SaveAsync(new QaSaveRequest
        {
          SessionId = SessionId == 0 ? null : SessionId,
          Question = _currentQuestion!,
          AskedAt = _currentQuestionAt,
          Answers = collected
        });
        if (!saveResult.Success) Messages.Add(new ChatMsg("error", "ä¿å­˜å¤±è´¥", saveResult.Message));
        else await LoadRecent();
      }
      catch (Exception ex)
      {
        Messages.Add(new ChatMsg("error", "ä¿å­˜å¼‚å¸¸", ex.Message));
      }
    }
    else
    {
      Messages.Add(new ChatMsg("error", "æç¤º", "æ¥æ”¶åˆ°å›ç­”ï¼Œä½†æœªè·å–åˆ°ä¸Šä¸€ä¸ªè€å¸ˆæé—®ã€‚"));
    }

    InvokeAsync(StateHasChanged);
  }
  
  [JSInvokable]
  public Task OnError(string message)
  {
    Messages.Add(new ChatMsg("error", "é”™è¯¯", message));
    Status = "å‘ç”Ÿé”™è¯¯ï¼ˆè§ä¸‹æ–¹ï¼‰";
    InvokeAsync(StateHasChanged);
    return Task.CompletedTask;
  }

  public record ChatMsg(string Kind, string Title, string Text);

  private async Task LoadRecent()
  {
    var list = await QuestionAnswerService.GetRecentAsync(TakeCount);
    RecentRecords = list.Select(Map).ToList();
    Expanded.Clear();
    StateHasChanged();
  }

  private QaRecordView Map(QaRecord r)
  {
    var answers = new List<StudentAnswerDto>();
    try
    {
      var parsed = JsonSerializer.Deserialize<List<StudentAnswerDto>>(r.AnswersJson,
        new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
      if (parsed != null) answers = parsed;
    }
    catch
    {
    }

    return new QaRecordView
    {
      Id = r.Id,
      SessionId = r.SessionId,
      Question = r.Question,
      AskedAt = r.AskedAt,
      Answers = answers
    };
  }

  private void ToggleAnswers(ulong id)
  {
    if (!Expanded.Add(id))
      Expanded.Remove(id);
  }

  private async Task SendToLlm(ulong? qaId = null)
  {
    if (IsEvaluating) return;

    try
    {
      IsEvaluating = true;
      EvalMessage = "æ­£åœ¨è°ƒç”¨ LLM è¯„ä¼°...";
      EvalResult = "";
      StateHasChanged();

      var payload = new QaEvaluationRequest
      {
        SessionId = qaId.HasValue ? null : (SessionId == 0 ? null : SessionId),
        QaIds = qaId.HasValue ? new List<ulong> { qaId.Value } : null,
        Take = TakeCount,
        SystemPrompt = null
      };

      var op = await QaEvaluationService.EvaluateAsync(payload);
      if (op.Success)
      {
        EvalMessage = "è¯„ä¼°å®Œæˆ";
        EvalResult = op.Data?.ToString() ?? string.Empty;
      }
      else
      {
        EvalMessage = op.Message;
        EvalResult = string.Empty;
      }
    }
    catch (Exception ex)
    {
      EvalMessage = $"è°ƒç”¨å¼‚å¸¸: {ex.Message}";
    }
    finally
    {
      IsEvaluating = false;
      StateHasChanged();
    }
  }

  private class QaRecordView
  {
    public ulong Id { get; set; }
    public int? SessionId { get; set; }
    public string Question { get; set; } = string.Empty;
    public DateTime AskedAt { get; set; }
    public List<StudentAnswerDto> Answers { get; set; } = new();
  }

  public async ValueTask DisposeAsync()
  {
    try
    {
      if (_module is not null)
        await _module.InvokeVoidAsync("stopClassroomLoop");
    }
    catch (JSDisconnectedException)
    {
      
    }
    catch
    {
      
    }

    _dotNetRef?.Dispose();
    if (_module is not null) await _module.DisposeAsync();
  }
}
